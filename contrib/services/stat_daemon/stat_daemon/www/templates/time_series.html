{% extends 'admin/base.html' %}

{% block head_css %}
{{ super() }}
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='bootstrap-slider.css') }}"></link>
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='bootstrap-datetimepicker.min.css') }}"></link>
<style>
#tolSlider .slider-selection {
    background: #BABABA;
}
</style>
{% endblock %}

{% block body %}
<!-- Flash tags created -->
<div id="alert-outliers" class="alert alert-info alert-dismissible" role="alert" style="display: none">
  <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
  Outliers flagged.  Go to <a href="/admin/tags">Tags</a> for more info.
</div>
<!-- Flash alert created -->
<div id="alert-alert" class="alert alert-info alert-dismissible" role="alert" style="display: none">
  <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
  Alert created.  Go to <a href="/admin/alerts">Alerts</a> for more info.
</div>
<!-- Chart -->
<div class="panel panel-default">
    <div class="panel panel-body">    
        <div class="row">
            <div id="chart-div" style="min-width: 310px; height: 550px; margin: 0 auto"></div>
        </div>
    </div>
</div>
<!-- Bottom Panel -->
<div class="well">
    <div class="row">
      <!-- Slider -->
      <div class="col-md-3">
        <input style="width:225px" id="tol-slider" data-slider-id='tolSlider' type="text" class="span2" value="" data-slider-min="{{ min_min_tol }}" data-slider-max="{{ max_max_tol }}" data-slider-step="{{ (max_max_tol - min_min_tol)/steps }}" data-slider-value="[{{ min_tol }},{{ max_tol }}]"/> 
      </div>
      <!-- Date Filters -->
      <div class="col-md-6">
        <div class="row">
          <div class="col-md-5">        
            <div class="form-group">
                <div class='input-group date' id='start-time'>
                    <input type='text' id="start-time-input" class="form-control" />
                    <span class="input-group-addon">
                        <span class="glyphicon glyphicon-calendar"></span>
                    </span>
                </div>
            </div>
          </div>
          <div class="col-md-5">
            <div class="form-group">
                <div class='input-group date' id='end-time'>
                    <input type='text' id='end-time-input' class="form-control"/>
                    <span class="input-group-addon">
                        <span class="glyphicon glyphicon-calendar"></span>
                    </span>
                </div>
            </div>
          </div>
          <div class="col-md-2">
          <button id="date-btn" class="btn btn-default btn-sm" data-toggle="tooltip" data-placement="top" title="Update date range"><span class="glyphicon glyphicon-refresh"></span></button>
          </div>        
        </div>
      </div>
      <!-- Checkboxes -->
      <div class="col-md-3">
        <div class="row">
          <div class="col-md-6">
            <input id="checkbox-detrend" type="checkbox" aria-label="..." data-toggle="tooltip" data-placement="top" title="Remove trend and plot residuals"> Detrend
          </div>
          <div class="col-md-6">        
            <input id="checkbox-autoscale" type="checkbox" aria-label="..." data-toggle="tooltip" data-placement="top" title="Autoscale tolerances"> Autoscale
          </div>
        </div>
        <div class="row">
          <div class="col-md-6">
            <input id="checkbox-outliers" type="checkbox" aria-label="..." data-toggle="tooltip" data-placement="top" title="Flag all outliers"> Flag outliers
          </div>
          <div class="col-md-6">
            <input id="checkbox-alert" type="checkbox" aria-label="..." data-toggle="tooltip" data-placement="top" title="Create alert for current parameters">Create Alert
          </div>
        </div>
      </div>
    </div>
</div>
<!-- Outlier Modal -->
<div class="modal fade" id="outliers-modal" tabindex="-1" role="dialog" aria-labelledby="outliers-modal-label" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="outliers-modal-label">Flag Outlier(s)</h4>
      </div>
      <div class="modal-body">
          <div class="row"><div class="col-md-12">
            <div class="btn-group">
              <button id="btn-outlier-category" type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                Category <span class="caret"></span>
              </button>
              <ul id="outlier-category-dropdown" class="dropdown-menu" role="menu">
                <li><a href="javascript:setOutlierCategory(0)">Generic</a></li>
                <li><a href="javascript:setOutlierCategory(1)">Logging Outage</a></li>
                <li><a href="javascript:setOutlierCategory(2)">Missing Data</a></li>
                <li><a href="javascript:setOutlierCategory(3)">Holiday / Special Event </a></li>
              </ul>
            </div>
          </div></div><br>
          <div class="row"><div class="col-md-12">
            <textarea class="form-control" rows="5" id="outliers-comment" placeholder="comments"></textarea>
          </div></div><br>
          <div class="row"><div class="col-md-12">
            <input style="width:300px" id="outliers-email" placeholder="email">
          </div></div>
          <div class="row"><div class="col-md-12">
            <h3>
            Tagged Items:
            </h3>
            <div class="well">
                <ul id="li-tagged-items">
                </ul>
            </div>
      </div></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button id="btn-submit-outliers" type="button" class="btn btn-primary">Submit</button>
      </div>
    </div>
  </div>
</div>
<!-- Alert Modal -->
<div class="modal fade" id="alert-modal" tabindex="-1" role="dialog" aria-labelledby="alert-modal-label" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="outliers-modal-label">Create Alert</h4>
      </div>
      <div class="modal-body">
          <div class="row">
            <div class="col-md-12">
              <input style="width:300px" id="alert-email" placeholder="recipient@airbnb.com">
            </div>
          </div>
          <br>
          <div class="row">
            <div class="col-md-12">
              <input style="width:300px" id="alert-subject" placeholder="subject">
            </div>
          </div>
          <br>
          <div class="row"><div class="col-md-12">
            <div class="btn-group">
              <button id="btn-alert-level" type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                Level <span class="caret"></span>
              </button>
              <ul id="alert-level-dropdown" class="dropdown-menu" role="menu">
                <li><a href="javascript:setAlertCategory(0)">Info</a></li>
                <li><a href="javascript:setAlertCategory(1)">Warning</a></li>
                <li><a href="javascript:setAlertCategory(2)">Error</a></li>
              </ul>
            </div>
          </div></div><br>
          <div class="row"><div class="col-md-12">
            <textarea class="form-control" rows="5" id="alert-content" placeholder="message content"></textarea>
          </div></div><br>
          <div class="row"><div class="col-md-12">
            <h3>
            Details:
            </h3>
            <div class="well">
                <ul id="li-alert-parameters">
                </ul>
            </div>
      </div></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button id="btn-submit-alert" type="button" class="btn btn-primary">Submit</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block tail %}
{{ super() }}
<script src="{{ url_for('static', filename='highstock.js') }}"></script>
<script src="{{ url_for('static', filename='highcharts.js') }}"></script>
<script src="{{ url_for('static', filename='highcharts-more.js') }}"></script>
<script src="{{ url_for('static', filename='bootstrap-slider.js') }}"></script>
<script src="{{ url_for('static', filename='moment.js') }}"></script>
<script src="{{ url_for('static', filename='bootstrap-datetimepicker.min.js') }}"></script>
<script type="text/javascript">

var taggedOutliers = []
function getTaggedOutliers() {
    if (taggedOutliers.length > 0) {
        return taggedOutliers
    }
    else {
        return {{ outliers|safe }}        
    }
}

function getTaggedOutliersList() {
    var outliers = getTaggedOutliers()
    var li = ''
    for (i=0; i<outliers.length; i++) {
        li += "<li>" + outliers[i] + "</li>"
    }
    return li
}

$("#btn-submit-outliers").click(function() {
    $("#outliers-modal").modal('hide')
    var params = getUpdatedParams()
    params['author'] = $("#outliers-email").val()
    params['comment'] = $("#outliers-comment").val()
    params['category'] = outlierCategory
    params['times'] = getTaggedOutliers()
    $.ajax({
      type: "POST",
      url: '/admin/tags/add',
      contentType: "application/json; charset=utf-8",
      dataType: 'json',
      data: JSON.stringify(params),
      complete: function() {
        $('#alert-outliers').show().delay(2500).fadeOut();
        taggedOutliers = []
      },
      success: function(data) {
        console.log("Ouliers flagged.  Go to /admin/tags to update them")
      },
      failure: function(err) {
        console.log("Failed to create ouliers: " + err)
      },
    });
});

$("#btn-submit-alert").click(function() {
    $("#alert-modal").modal('hide')
    var params = getUpdatedParams()
    params['email'] = $("#alert-email").val()
    if (params['email'] == '') {
        params['email'] = "N/A"
    }
    params['subject'] = $("#alert-subject").val()
    params['level'] = alertLevel
    params['message'] = $("#alert-content").val()
    params['detrend'] = {{ detrend_info|safe }}
    $.ajax({
      type: "POST",
      url: '/admin/alerts/crud',
      contentType: "application/json; charset=utf-8",
      dataType: 'json',
      data: JSON.stringify({'create': params}),
      complete: function() {
        $('#alert-alert').show().delay(2500).fadeOut();
      },
      success: function(data) {
        console.log("Ouliers flagged.  Go to /admin/tags to update them")
      },
      failure: function(err) {
        console.log("Failed to create ouliers: " + err)
      },
    });
});

function getPlotOptions() {
    return {
        series: {
            allowPointSelect: true,
            point: {
                events: {
                    select: function () {
                        taggedOutliers.push(moment.utc(this.category)
                                      .format('YYYY-MM-DD HH:mm:ss'))
                        $('#li-tagged-items').html(getTaggedOutliersList())
                        $('#outliers-modal').modal('show');
                    }
                }
            }
        }
    }
}

$(function () {
    var chart = JSON.parse('{{ chart|safe }}')
    chart['plotOptions'] = getPlotOptions()
    $('#chart-div').highcharts('StockChart', chart)
});

$(function(){
    $("#outlier-category-dropdown li a").click(function(){
      $("#btn-outlier-category").text($(this).text());
      $("#btn-outlier-category").val($(this).text());
   });
    $("#alert-level-dropdown li a").click(function(){
      $("#btn-alert-level").text($(this).text());
      $("#btn-alert-level").val($(this).text());
   });
});

function getQueryParams() {
    var qs = document.location.search;
    qs = qs.split("+").join(" ");
    var params = {}, tokens,
        re = /[?&]?([^=]+)=([^&]*)/g;
    while (tokens = re.exec(qs)) {
        params[decodeURIComponent(tokens[1])]
            = decodeURIComponent(tokens[2]);
    }
    return params;
}

function formatQueryString(params) {    
    var kv = Array()
    for (key in params) {
        kv.push(key + "=" + params[key])
    }
    return "?" + kv.join("&")
}

$("#tol-slider").slider({
    formatter: function(val) {
        if (Array.isArray(val)) {
            var ret = "min: " + Math.round(val[0]*100)/100.0;
            ret += ", max: " + Math.round(val[1]*100)/100.0;
            return ret
        } else {
            return val;
        }
    },
    width: 1000,
});

$(function () {
    var params = getQueryParams()
    if ('detrend' in params) {
        if (params['detrend'] == true || params['detrend'] == 'true') {
            $("#checkbox-detrend").prop('checked', true);
        }
    }

})

$("#date-btn").click(refresh);

var isDate = function(date) {
    return ( (new Date(date) !== "Invalid Date" && !isNaN(new Date(date)) ));
}

var outlierCategory = 0
function setOutlierCategory(cls) {
    outlierCategory = cls;
}

var alertLevel = 0
function setAlertCategory(cls) {
    alertLevel = cls;
}

function getUpdatedParams() {
    var start_time = $("#start-time-input").val()
    var end_time = $("#end-time-input").val()
    var range = $("#tol-slider").val();
    var min_tol = range.split(',')[0]
    var max_tol = range.split(',')[1]
    var detrend = $("#checkbox-detrend").is(':checked')
    var autoscale = $("#checkbox-autoscale").is(':checked')
    var params = getQueryParams()
    if (isDate(start_time)) {
        params['start_time'] = start_time
    }
    if (isDate(end_time)) {
        params['end_time'] = end_time
    }
    params['min_tol'] = min_tol
    params['max_tol'] = max_tol
    params['detrend'] = detrend
    params['autoscale'] = autoscale
    return params
}

function refresh() {
    var query_string = formatQueryString(getUpdatedParams())
    document.location = window.location.pathname + query_string
}

$(function () {
    $('[data-toggle="tooltip"]').tooltip()
});

$(function () {
    var params = getQueryParams()
    var start_time = '2011-01-01 00:00:00'
    var end_time = moment().format('YYYY-MM-DD 00:00:00')
    if ('start_time' in params) {
        start_time = params['start_time']
    }
    if ('end_time' in params) {
        end_time = params['end_time']
    }
    $('#start-time').datetimepicker({
        defaultDate: start_time,
        format: 'YYYY-MM-DD HH:MM:SS'
    });
    $('#end-time').datetimepicker({
        defaultDate: end_time,
        format: 'YYYY-MM-DD HH:MM:SS',
    });
});

var timeout = null;
$("#tol-slider").change(function(e){
  if($(this).data("lastval")!= $(this).val()){
    $(this).data("lastval",$(this).val());
    if (timeout !== null) {
      clearTimeout(timeout);
    }
    timeout = setTimeout(refresh, 500);
  };
});

$('#checkbox-outliers').click(function() {
    if ($(this).is(':checked')) {
        taggedOutliers = []
        $('#li-tagged-items').html(getTaggedOutliersList())
        $('#outliers-modal').modal('show');
    }
});

$('#checkbox-alert').click(function() {
    if ($(this).is(':checked')) {
        taggedOutliers = []
        var params = getQueryParams()
        var html = ""
        for (key in params) {
            html += "<li> " + key + "=" + params[key] + "</li>"
        }
        $('#li-alert-parameters').html(html)
        $('#alert-modal').modal('show');
    }
});

$('#checkbox-detrend').click(refresh);

$('#checkbox-autoscale').click(refresh);

</script>
{% endblock %}